{% extends "layout.html" %}
{% block content %}

<h3>Administrar usuarios</h3>

<a href="{{ url_for('user_new') }}" class="btn btn-success mb-3">Crear usuario</a>

<div class="card p-3 shadow">
    <h2 class="mb-3">GestiÃ³n de usuarios ðŸ‘¤</h2>

    <table class="table table-striped">
    <thead>
        <tr>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
    {% for u in users %}
        <tr>
            <td>{{ u.username }}</td>
            <td>{{ u.role }}</td>
            <td>
                {% if u.active == 1 %}
                    <span class="badge bg-success">Activo</span>
                {% else %}
                    <span class="badge bg-secondary">Inactivo</span>
                {% endif %}
            </td>
            <td>
                <a class="btn btn-warning btn-sm" href="{{ url_for('user_edit', username=u.username) }}">Editar</a>
                <button class="btn btn-danger btn-sm"
                        onclick="toggleActive('{{ u.username }}', '{{ u.active }}')">
                    {% if u.active == 1 %}Desactivar{% else %}Activar{% endif %}
                </button>
            </td>
        </tr>
    {% endfor %}
    </tbody>
    </table>
</div>

<script>
async function toggleActive(username, status) {
    const current = parseInt(status);
    const newState = current === 1 ? 0 : 1;

    const res = await fetch(`/api/users/${username}`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ active: newState })
    });

    const result = await res.json();
    alert(result.message);
    if (res.status === 200) location.reload();
}
</script>

{% endblock %}
